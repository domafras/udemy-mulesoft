<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:db="http://www.mulesoft.org/schema/mule/db"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd 
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd">
	<sub-flow name="implementation-salvar-usuario-main"
		doc:id="fee2e7eb-d5cf-4256-9a2c-9e521f63377f">
		<flow-ref doc:name="Salvar Tabela Usuario" doc:id="5ad1b735-8cfa-46c5-8aa7-a827c17f1e1f" name="implementation-salvar-usuario-salvar-table-client"/>
		<flow-ref doc:name="Salvar Tabela EndereÃ§o" doc:id="2d25adfe-59d0-4b84-8529-2bca3f77c4f3" name="implementation-salvar-usuario-salvar-table-address"/>
		<flow-ref doc:name="Salvar Tabela Telefone" doc:id="835c925f-83bc-4ade-a556-96e72cfd4c69" name="implementation-salvar-usuario-salvar-table-phone"/>
		<ee:transform doc:name="Transform Message"
			doc:id="4d7e4379-a9f7-41ba-9f38-87de4612fd09">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
    message: "Cliente criado com sucesso.",
    id_client: vars.idClient
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
	
</sub-flow>
	<sub-flow name="implementation-salvar-usuario-salvar-table-client" doc:id="143da2ef-3cbb-4a28-85cf-3d148e0910d4" >
		<ee:transform doc:name="Transform Message" doc:id="f373df98-3419-40b2-a907-8a18b68dbf8b">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
	pNome: vars.inputPayload.nome,
	pSobrenome: vars.inputPayload.sobrenome
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<db:insert doc:name="Insert Cliente" doc:id="59b96cfe-39bc-407d-9819-47892a3d9cb0" config-ref="Heroku-Postgres" autoGenerateKeys="true">
			<db:sql><![CDATA[INSERT INTO public.client(
	name, lastname)
VALUES (:pNome, :pSobrenome) RETURNING id_client;]]></db:sql>
			<db:parameter-types />
			<db:input-parameters><![CDATA[#[payload]]]></db:input-parameters>
			<db:auto-generated-keys-column-names>
				<db:auto-generated-keys-column-name value="id_client" />
			</db:auto-generated-keys-column-names>
		</db:insert>
		<set-variable value="#[(payload.generatedKeys.id_client default 0) as String]" doc:name="Id Client" doc:id="2d0b2f0c-3d35-4455-b726-ed658fc6a3be" variableName="idClient"/>
	</sub-flow>
	<sub-flow name="implementation-salvar-usuario-salvar-table-address" doc:id="e42a230d-e1a9-4890-b436-6cb5ab708af9" >
		<ee:transform doc:name="Transform Message" doc:id="2013280f-90c2-4b95-99ec-b414696ea557" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/java
var endereco = vars.inputPayload.endereco
---
{
	pId_cliente: vars.idClient,
	pCep: endereco.cep default "",
	pCidade: endereco.cidade,
	pEstado: endereco.estado,
	pRua: endereco.rua
}

]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<db:insert doc:name="Insert Endereco" doc:id="4489849a-01fd-4ed4-9c0d-685215bdcd5a" config-ref="Heroku-Postgres">
			<db:sql ><![CDATA[INSERT INTO public.address(
	id_client, zip_code, city, uf, street)
VALUES (:pId_cliente, :pCep, :pCidade, :pEstado, :pRua);]]></db:sql>
			<db:parameter-types />
			<db:input-parameters ><![CDATA[#[payload]]]></db:input-parameters>
			<db:auto-generated-keys-column-names >
				<db:auto-generated-keys-column-name value="id_client" />
			</db:auto-generated-keys-column-names>
		</db:insert>
	</sub-flow>
	<sub-flow name="implementation-salvar-usuario-salvar-table-phone" doc:id="cf59e66d-34a3-4c33-863b-f1342ea67594" >
		<ee:transform doc:name="Transform Message" doc:id="3964e1bd-03b0-41e9-98e9-550459e1bfda" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/java
var telefone = vars.inputPayload.telefones
var empty_string = ""
---
telefone map (
        {
        	pId_cliente: vars.idClient,
            pNumero_telefone: ($.ddd as String default "") ++ 
            ($.numero as String default "")
        }
    )
]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<db:bulk-insert doc:name="Bulk insert" doc:id="f9620d83-0ef3-43fc-8a98-d099c609cd92" config-ref="Heroku-Postgres">
			<db:sql ><![CDATA[INSERT INTO public.phone(
	id_client, phone_number)
VALUES (:pId_cliente, :pNumero_telefone);]]></db:sql>
		</db:bulk-insert>
	</sub-flow>
</mule>
